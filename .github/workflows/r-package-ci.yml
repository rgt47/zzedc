name: R Package CI/CD

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    # Run weekly to catch dependency issues
    - cron: '0 6 * * 1'

env:
  R_REMOTES_NO_ERRORS_FROM_WARNINGS: true
  RSPM: https://packagemanager.rstudio.com/cran/__linux__/jammy/latest
  GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # Check if this is an R package and zzcollab framework compatible
  detect-package:
    runs-on: ubuntu-latest
    outputs:
      is-r-package: ${{ steps.check.outputs.is-r-package }}
      zzcollab-compatible: ${{ steps.zzcollab.outputs.compatible }}
    steps:
      - uses: actions/checkout@v4

      - id: check
        name: Check if R package
        run: |
          if [[ -f "DESCRIPTION" ]] && [[ -f "NAMESPACE" ]]; then
            echo "is-r-package=true" >> $GITHUB_OUTPUT
          else
            echo "is-r-package=false" >> $GITHUB_OUTPUT
          fi

      - id: zzcollab
        name: Check zzcollab framework compatibility
        run: |
          echo "Checking zzcollab framework integration..."
          missing_files=()

          if [[ ! -f "bundles.yaml" ]]; then
            missing_files+=("bundles.yaml")
          fi
          if [[ ! -f "config.yaml" ]]; then
            missing_files+=("config.yaml")
          fi
          if [[ ! -f "Dockerfile" ]]; then
            missing_files+=("Dockerfile")
          fi

          if [[ ${#missing_files[@]} -eq 0 ]]; then
            echo "compatible=true" >> $GITHUB_OUTPUT
            echo "‚úì zzcollab framework files present"
          else
            echo "compatible=false" >> $GITHUB_OUTPUT
            echo "‚úó Missing zzcollab files: ${missing_files[*]}"
          fi

  # R package testing matrix
  r-package-check:
    needs: detect-package
    if: needs.detect-package.outputs.is-r-package == 'true'
    runs-on: ${{ matrix.config.os }}
    name: ${{ matrix.config.os }} (R-${{ matrix.config.r }})

    strategy:
      fail-fast: false
      matrix:
        config:
          - { os: ubuntu-latest, r: 'release' }
          - { os: ubuntu-latest, r: 'devel' }
          - { os: ubuntu-latest, r: 'oldrel-1' }
          - { os: windows-latest, r: 'release' }
          - { os: macOS-latest, r: 'release' }

    env:
      R_KEEP_PKG_SOURCE: yes

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-pandoc@v2

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.config.r }}
          http-user-agent: ${{ matrix.config.http-user-agent }}
          use-public-rspm: true

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev \
            libharfbuzz-dev \
            libfribidi-dev \
            libfreetype6-dev \
            libpng-dev \
            libtiff5-dev \
            libjpeg-dev \
            libsqlite3-dev

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::rcmdcheck
            any::covr
            any::pkgdown
          needs: check

      - name: Session info
        run: |
          options(width = 100)
          pkgs <- installed.packages()[, "Package"]
          sessioninfo::session_info(pkgs, include_base = TRUE)
        shell: Rscript {0}

      - uses: r-lib/actions/check-r-package@v2
        with:
          args: 'c("--no-manual", "--as-cran")'
          error-on: '"warning"'
          check-dir: '"check"'

      - name: Show testthat output
        if: always()
        run: find check -name 'testthat.Rout*' -exec cat '{}' \; || true
        shell: bash

      - name: Upload check results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ runner.os }}-r${{ matrix.config.r }}-results
          path: check

  # Code coverage
  test-coverage:
    needs: detect-package
    if: needs.detect-package.outputs.is-r-package == 'true'
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::covr
          needs: coverage

      - name: Test coverage
        run: |
          cov <- covr::package_coverage(
            quiet = FALSE,
            clean = FALSE,
            install_path = file.path(Sys.getenv("RUNNER_TEMP"), "package")
          )
          covr::to_cobertura(cov)
        shell: Rscript {0}

      - uses: codecov/codecov-action@v4
        with:
          fail_ci_if_error: ${{ github.event_name != 'pull_request' && true || false }}
          file: ./cobertura.xml
          plugin: noop
          disable_search: true
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Show coverage summary
        run: |
          cat("Coverage Summary:\n")
          print(covr::package_coverage())
        shell: Rscript {0}

  # Lint code
  lint:
    needs: detect-package
    if: needs.detect-package.outputs.is-r-package == 'true'
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::lintr
          needs: check

      - name: Lint
        run: lintr::lint_package()
        shell: Rscript {0}
        env:
          LINTR_ERROR_ON_LINT: true

  # Build and deploy pkgdown site
  pkgdown:
    needs: [detect-package, r-package-check]
    if: |
      needs.detect-package.outputs.is-r-package == 'true' &&
      github.event_name != 'pull_request' &&
      github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-pandoc@v2

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::pkgdown
            local::.
          needs: website

      - name: Build site
        run: pkgdown::build_site_github_pages(new_process = FALSE, install = FALSE)
        shell: Rscript {0}

      - name: Configure Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Deploy Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Performance benchmarks
  benchmark:
    needs: detect-package
    if: needs.detect-package.outputs.is-r-package == 'true'
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::bench
            any::profvis
            local::.
          needs: check

      - name: Run benchmarks
        run: |
          if (file.exists("benchmarks/")) {
            bench_files <- list.files("benchmarks/", pattern = "\\.R$", full.names = TRUE)
            for (file in bench_files) {
              cat("Running benchmark:", file, "\n")
              source(file)
            }
          } else {
            cat("No benchmarks directory found - creating sample benchmark\n")

            # Sample benchmark for ZZedc
            library(bench)
            library(zzedc)

            # Benchmark database operations
            results <- bench::mark(
              "db_connection" = {
                cfg <- list(database = list(path = ":memory:", pool_size = 2))
                pool <- pool::dbPool(RSQLite::SQLite(), dbname = cfg$database$path,
                                   minSize = 1, maxSize = cfg$database$pool_size)
                pool::poolClose(pool)
              },
              "data_validation" = {
                test_data <- data.frame(
                  subject_id = paste0("SUBJ", 1:100),
                  age = sample(18:80, 100, replace = TRUE),
                  date = Sys.Date() + sample(-30:30, 100, replace = TRUE)
                )
                # Simple validation
                validated <- test_data[complete.cases(test_data), ]
                nrow(validated)
              },
              iterations = 50,
              check = FALSE
            )

            print(results)
            summary(results)
          }
        shell: Rscript {0}

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            benchmarks/
            *.png
            *.svg
        if: always()

  # Security scanning
  security-scan:
    needs: detect-package
    if: needs.detect-package.outputs.is-r-package == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Run R security checks
        run: |
          # Check for common security issues in R code
          echo "üîç Scanning for security issues..."

          # Check for potential SQL injection
          if grep -r "paste.*SQL\|paste0.*SQL" R/ --include="*.R" 2>/dev/null; then
            echo "‚ö†Ô∏è  Potential SQL injection risk found"
            exit 1
          fi

          # Check for hardcoded credentials
          if grep -ri "password.*=.*['\"][^'\"]*['\"]" . --include="*.R" --include="*.Rmd" 2>/dev/null; then
            echo "‚ö†Ô∏è  Potential hardcoded credentials found"
            exit 1
          fi

          # Check for eval/system calls
          if grep -r "eval\|system\|system2" R/ --include="*.R" 2>/dev/null; then
            echo "‚ö†Ô∏è  Potentially dangerous function calls found"
            echo "‚ÑπÔ∏è  Review usage of eval(), system(), or system2() functions"
          fi

          echo "‚úÖ Security scan completed"

      - name: Dependency vulnerability scan
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Check dependencies for known vulnerabilities
        run: |
          # Install oysteR for vulnerability scanning
          if (!requireNamespace("oysteR", quietly = TRUE)) {
            install.packages("oysteR")
          }

          # Scan dependencies
          results <- oysteR::audit_deps()
          if (nrow(results) > 0) {
            cat("‚ö†Ô∏è  Vulnerabilities found in dependencies:\n")
            print(results)
          } else {
            cat("‚úÖ No known vulnerabilities in dependencies\n")
          }
        shell: Rscript {0}
        continue-on-error: true

  # Package release (triggered by tags)
  release:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    needs: [r-package-check, test-coverage]
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::pkgbuild
            any::devtools
          needs: check

      - name: Build package
        run: |
          pkgbuild::build(dest_path = ".")
          built_package <- list.files(pattern = "*.tar.gz", full.names = TRUE)
          cat("Built package:", built_package, "\n")
          Sys.setenv(BUILT_PACKAGE = built_package)
        shell: Rscript {0}

      - name: Generate release notes
        run: |
          # Extract version from tag
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV

          # Generate release notes
          cat > release_notes.md << EOF
          ## ZZedc v$VERSION

          ### Package Information
          - **R Package**: zzedc_$VERSION.tar.gz
          - **Documentation**: [Package Website](https://rgt47.github.io/zzedc/)
          - **Installation**: \`install.packages("zzedc_$VERSION.tar.gz", repos = NULL, type = "source")\`

          ### Features
          - Electronic Data Capture for Clinical Trials
          - Modern Shiny interface with Bootstrap 5
          - Comprehensive test suite (200+ tests)
          - Four detailed vignettes for different project sizes
          - Advanced security and compliance features

          ### System Requirements
          - R >= 4.0.0
          - Modern web browser
          - 4GB RAM recommended

          ### Quick Start
          \`\`\`r
          library(zzedc)
          launch_zzedc()
          \`\`\`

          Login with: username \`test\`, password \`test\`
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.tar.gz
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Notify on completion
  notify:
    needs: [r-package-check, test-coverage, lint]
    if: always() && github.event_name != 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Workflow Summary
        run: |
          echo "## üéØ ZZedc CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Package Check | ${{ needs.r-package-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Coverage | ${{ needs.test-coverage.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Linting | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üì¶ **Package**: ZZedc Electronic Data Capture System" >> $GITHUB_STEP_SUMMARY
          echo "üîó **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "üìã **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY