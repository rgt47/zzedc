name: Security Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly security scans
    - cron: '0 2 * * 1'
  workflow_dispatch:

env:
  R_REMOTES_NO_ERRORS_FROM_WARNINGS: true

jobs:
  # Static code analysis
  code-analysis:
    runs-on: ubuntu-latest
    name: Code Security Analysis

    steps:
      - uses: actions/checkout@v4

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Install security analysis tools
        run: |
          install.packages(c("banR", "oysteR", "lintr"))
        shell: Rscript {0}

      - name: Static security analysis
        run: |
          cat("üîç Static Code Security Analysis\n")
          cat("================================\n\n")

          # Check for potential SQL injection vulnerabilities
          cat("1. SQL Injection Detection:\n")
          sql_files <- list.files(".", pattern = "\\.R$", recursive = TRUE, full.names = TRUE)

          for (file in sql_files) {
            content <- readLines(file, warn = FALSE)

            # Check for paste/sprintf with SQL
            sql_paste <- grep("paste.*SQL|sprintf.*SQL|glue.*SQL", content, ignore.case = TRUE)
            if (length(sql_paste) > 0) {
              cat("‚ö†Ô∏è  Potential SQL injection risk in", file, "lines:", paste(sql_paste, collapse = ", "), "\n")
            }

            # Check for direct string concatenation in SQL
            sql_concat <- grep("\\$.*SQL|\\+.*SQL", content, ignore.case = TRUE)
            if (length(sql_concat) > 0) {
              cat("‚ö†Ô∏è  SQL concatenation detected in", file, "lines:", paste(sql_concat, collapse = ", "), "\n")
            }
          }
          cat("   ‚úÖ SQL injection scan completed\n\n")

          # Check for hardcoded secrets
          cat("2. Hardcoded Secrets Detection:\n")
          secret_patterns <- c(
            "password\\s*=\\s*[\"'][^\"']{3,}[\"']",
            "secret\\s*=\\s*[\"'][^\"']{10,}[\"']",
            "token\\s*=\\s*[\"'][^\"']{10,}[\"']",
            "key\\s*=\\s*[\"'][^\"']{10,}[\"']",
            "api_key\\s*=\\s*[\"'][^\"']{10,}[\"']"
          )

          for (file in sql_files) {
            content <- readLines(file, warn = FALSE)
            for (pattern in secret_patterns) {
              matches <- grep(pattern, content, ignore.case = TRUE)
              if (length(matches) > 0) {
                cat("‚ö†Ô∏è  Potential hardcoded secret in", file, "lines:", paste(matches, collapse = ", "), "\n")
              }
            }
          }
          cat("   ‚úÖ Hardcoded secrets scan completed\n\n")

          # Check for dangerous function calls
          cat("3. Dangerous Function Detection:\n")
          dangerous_funcs <- c("eval", "system", "system2", "shell", "file.show")

          for (file in sql_files) {
            content <- readLines(file, warn = FALSE)
            for (func in dangerous_funcs) {
              matches <- grep(paste0("\\b", func, "\\s*\\("), content)
              if (length(matches) > 0) {
                cat("‚ö†Ô∏è  Dangerous function '", func, "' found in", file, "lines:", paste(matches, collapse = ", "), "\n")
              }
            }
          }
          cat("   ‚úÖ Dangerous function scan completed\n\n")

          cat("üîí Static analysis completed\n")
        shell: Rscript {0}

      - name: R package security scan
        run: |
          if (!requireNamespace("oysteR", quietly = TRUE)) {
            cat("Installing oysteR for vulnerability scanning...\n")
            install.packages("oysteR")
          }

          cat("üõ°Ô∏è  R Package Vulnerability Scan\n")
          cat("=================================\n\n")

          # Scan package dependencies for known vulnerabilities
          tryCatch({
            vulns <- oysteR::audit_deps()

            if (nrow(vulns) > 0) {
              cat("‚ö†Ô∏è  Vulnerabilities found:\n")
              print(vulns)

              # Check severity levels
              high_severity <- sum(vulns$severity == "HIGH", na.rm = TRUE)
              medium_severity <- sum(vulns$severity == "MEDIUM", na.rm = TRUE)

              if (high_severity > 0) {
                cat("\n‚ùå HIGH SEVERITY vulnerabilities found:", high_severity, "\n")
                stop("High severity vulnerabilities detected")
              } else if (medium_severity > 0) {
                cat("\n‚ö†Ô∏è  MEDIUM SEVERITY vulnerabilities found:", medium_severity, "\n")
              }
            } else {
              cat("‚úÖ No known vulnerabilities found in dependencies\n")
            }
          }, error = function(e) {
            cat("‚ö†Ô∏è  Vulnerability scan failed:", e$message, "\n")
            cat("Continuing with other security checks...\n")
          })
        shell: Rscript {0}
        continue-on-error: true

  # Dependency scanning
  dependency-scan:
    runs-on: ubuntu-latest
    name: Dependency Security Scan

    steps:
      - uses: actions/checkout@v4

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Install dependencies
        uses: r-lib/actions/setup-r-dependencies@v2

      - name: Dependency security analysis
        run: |
          cat("üì¶ Dependency Security Analysis\n")
          cat("==============================\n\n")

          # Check for outdated packages
          cat("1. Checking for outdated packages:\n")
          tryCatch({
            old_pkgs <- old.packages()
            if (!is.null(old_pkgs)) {
              cat("‚ö†Ô∏è  Outdated packages found:\n")
              print(old_pkgs[, c("Package", "Installed", "ReposVer")])
            } else {
              cat("‚úÖ All packages are up to date\n")
            }
          }, error = function(e) {
            cat("Could not check package versions:", e$message, "\n")
          })

          # Check DESCRIPTION for security-relevant dependencies
          cat("\n2. Analyzing DESCRIPTION dependencies:\n")
          if (file.exists("DESCRIPTION")) {
            desc <- read.dcf("DESCRIPTION")

            # Extract all dependencies
            deps <- character(0)
            dep_fields <- c("Depends", "Imports", "Suggests")

            for (field in dep_fields) {
              if (field %in% colnames(desc)) {
                field_deps <- strsplit(desc[1, field], ",")[[1]]
                field_deps <- trimws(gsub("\\([^)]*\\)", "", field_deps))
                field_deps <- field_deps[field_deps != "R" & field_deps != ""]
                deps <- c(deps, field_deps)
              }
            }

            # Flag potentially risky packages
            risky_patterns <- c("system", "shell", "exec", "eval", "unsafe")
            risky_deps <- deps[grepl(paste(risky_patterns, collapse = "|"), deps, ignore.case = TRUE)]

            if (length(risky_deps) > 0) {
              cat("‚ö†Ô∏è  Potentially risky dependencies:\n")
              for (dep in risky_deps) {
                cat("   -", dep, "\n")
              }
            } else {
              cat("‚úÖ No obviously risky dependencies detected\n")
            }

            cat("Total dependencies analyzed:", length(deps), "\n")
          }

          cat("\nüîç Dependency analysis completed\n")
        shell: Rscript {0}

  # File and permission scanning
  file-security:
    runs-on: ubuntu-latest
    name: File Security Scan

    steps:
      - uses: actions/checkout@v4

      - name: File security analysis
        run: |
          echo "üìÅ File Security Analysis"
          echo "========================="
          echo

          # Check for sensitive files
          echo "1. Checking for sensitive files:"
          sensitive_files=(
            "*.key"
            "*.pem"
            "*.p12"
            "*.pfx"
            "id_rsa*"
            "id_dsa*"
            "*.crt"
            "*.cer"
            "config.json"
            ".env"
            ".secret"
            "credentials*"
          )

          found_sensitive=false
          for pattern in "${sensitive_files[@]}"; do
            files=$(find . -name "$pattern" -type f 2>/dev/null)
            if [ ! -z "$files" ]; then
              echo "‚ö†Ô∏è  Found sensitive file pattern: $pattern"
              echo "$files"
              found_sensitive=true
            fi
          done

          if [ "$found_sensitive" = false ]; then
            echo "‚úÖ No sensitive files found"
          fi

          # Check file permissions
          echo
          echo "2. Checking file permissions:"
          executable_files=$(find . -type f -executable -name "*.R" -o -name "*.Rmd" 2>/dev/null)
          if [ ! -z "$executable_files" ]; then
            echo "‚ö†Ô∏è  Executable R files found (potential security risk):"
            echo "$executable_files"
          else
            echo "‚úÖ No executable R files found"
          fi

          # Check for world-writable files
          world_writable=$(find . -type f -perm -002 2>/dev/null)
          if [ ! -z "$world_writable" ]; then
            echo "‚ö†Ô∏è  World-writable files found:"
            echo "$world_writable"
          else
            echo "‚úÖ No world-writable files found"
          fi

          echo
          echo "üîí File security scan completed"

  # Configuration security
  config-security:
    runs-on: ubuntu-latest
    name: Configuration Security

    steps:
      - uses: actions/checkout@v4

      - name: Setup R
        uses: r-lib/actions/setup-r@v2

      - name: Configuration security analysis
        run: |
          cat("‚öôÔ∏è  Configuration Security Analysis\n")
          cat("===================================\n\n")

          # Check config.yml for security issues
          if (file.exists("config.yml")) {
            cat("1. Analyzing config.yml:\n")
            config_content <- readLines("config.yml", warn = FALSE)

            # Check for hardcoded passwords
            password_lines <- grep("password:", config_content, ignore.case = TRUE)
            if (length(password_lines) > 0) {
              cat("‚ö†Ô∏è  Password configuration found in config.yml lines:", paste(password_lines, collapse = ", "), "\n")
              cat("   Ensure passwords are set via environment variables\n")
            }

            # Check for hardcoded API keys
            key_lines <- grep("key:|token:|secret:", config_content, ignore.case = TRUE)
            if (length(key_lines) > 0) {
              cat("‚ö†Ô∏è  API keys/tokens found in config.yml lines:", paste(key_lines, collapse = ", "), "\n")
              cat("   Ensure secrets are set via environment variables\n")
            }

            # Check for development configurations in production
            dev_lines <- grep("localhost|127.0.0.1|test|debug.*true", config_content, ignore.case = TRUE)
            if (length(dev_lines) > 0) {
              cat("‚ö†Ô∏è  Development configurations found lines:", paste(dev_lines, collapse = ", "), "\n")
              cat("   Review for production deployment\n")
            }

            cat("   ‚úÖ config.yml security scan completed\n")
          } else {
            cat("‚ÑπÔ∏è  No config.yml found\n")
          }

          # Check R files for configuration security
          cat("\n2. R configuration analysis:\n")
          r_files <- list.files(".", pattern = "\\.R$", recursive = TRUE, full.names = TRUE)

          for (file in r_files) {
            content <- readLines(file, warn = FALSE)

            # Check for Sys.setenv with sensitive data
            setenv_lines <- grep("Sys\\.setenv.*=.*[\"'][^\"']{8,}[\"']", content)
            if (length(setenv_lines) > 0) {
              cat("‚ö†Ô∏è  Environment variable setting in", file, "lines:", paste(setenv_lines, collapse = ", "), "\n")
            }

            # Check for options() with sensitive data
            options_lines <- grep("options\\(.*password|options\\(.*key|options\\(.*secret", content, ignore.case = TRUE)
            if (length(options_lines) > 0) {
              cat("‚ö†Ô∏è  Sensitive options() configuration in", file, "lines:", paste(options_lines, collapse = ", "), "\n")
            }
          }

          cat("   ‚úÖ R configuration security scan completed\n")

          cat("\nüõ°Ô∏è  Configuration security analysis completed\n")
        shell: Rscript {0}

  # Generate security report
  security-report:
    needs: [code-analysis, dependency-scan, file-security, config-security]
    if: always()
    runs-on: ubuntu-latest
    name: Security Report

    steps:
      - name: Generate security summary
        run: |
          echo "## üõ°Ô∏è ZZedc Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Type | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Analysis | ${{ needs.code-analysis.result }} | Static code security analysis |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | ${{ needs.dependency-scan.result }} | Package vulnerability assessment |" >> $GITHUB_STEP_SUMMARY
          echo "| File Security | ${{ needs.file-security.result }} | File permissions and sensitive data |" >> $GITHUB_STEP_SUMMARY
          echo "| Config Security | ${{ needs.config-security.result }} | Configuration security review |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Use environment variables for all sensitive configuration" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Regularly update package dependencies" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Avoid hardcoding credentials in source code" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Use parameterized queries for database operations" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Implement proper input validation and sanitization" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Review any warnings or failures above" >> $GITHUB_STEP_SUMMARY
          echo "- Update vulnerable dependencies if found" >> $GITHUB_STEP_SUMMARY
          echo "- Follow security best practices for R/Shiny applications" >> $GITHUB_STEP_SUMMARY