===============================================================================
      FEATURES #16 & #17: CONSENT MANAGEMENT - COMPLETE (100%)
===============================================================================

Completed: December 19, 2025
Priority: CRITICAL
Feasibility: MODERATE
Regulatory: GDPR Article 7

Note: Features #16 (Consent Withdrawal) and #17 (Consent Management System)
have been combined into a single comprehensive implementation.

-------------------------------------------------------------------------------
DELIVERABLES
-------------------------------------------------------------------------------

1. Consent Management System
   R/consent.R (~1300 lines)
   - Purpose definition and management
   - Consent recording with full audit trail
   - Consent withdrawal (individual and bulk)
   - Withdrawal request management
   - Consent checking and validation
   - Consent refresh functionality
   - Statistics and reporting

2. Comprehensive Test Suite
   tests/testthat/test-consent.R (~600 lines)
   - 45 test cases with 116 expectations
   - All tests passing

-------------------------------------------------------------------------------
FUNCTIONS IMPLEMENTED
-------------------------------------------------------------------------------

Initialization:
  - init_consent()                  : Creates 5 database tables + indexes

Reference Data:
  - get_consent_methods()           : CHECKBOX, SIGNATURE, VERBAL, etc.
  - get_consent_legal_bases()       : CONSENT, EXPLICIT_CONSENT
  - get_withdrawal_scopes()         : ALL, SPECIFIC, CATEGORY
  - get_consent_statuses()          : PENDING, GIVEN, WITHDRAWN, EXPIRED

Purpose Management:
  - create_consent_purpose()        : Creates consent purpose
  - get_consent_purposes()          : Retrieves purposes (active/all)
  - deactivate_consent_purpose()    : Deactivates purpose (keeps for audit)

Consent Recording:
  - record_consent()                : Records consent with hash-chain
  - log_consent_action()            : Logs action to audit history

Consent Withdrawal:
  - withdraw_consent()              : Withdraws specific consent
  - withdraw_all_consents()         : Withdraws all consents for subject
  - create_withdrawal_request()     : Creates formal withdrawal request
  - process_withdrawal_request()    : Processes withdrawal request

Consent Checking:
  - check_consent()                 : Checks if consent given for purpose
  - get_subject_consents()          : Gets all consents for subject
  - get_consent_history()           : Gets audit history for consent
  - get_pending_withdrawal_requests(): Gets pending withdrawal requests

Consent Refresh:
  - refresh_consent()               : Refreshes/renews existing consent

Statistics and Reporting:
  - get_consent_statistics()        : Returns comprehensive metrics
  - generate_consent_report()       : Creates compliance report (TXT/JSON)

-------------------------------------------------------------------------------
DATABASE SCHEMA
-------------------------------------------------------------------------------

consent_purposes:
  - purpose_id               : Primary key
  - purpose_code             : Unique code (e.g., "MARKETING")
  - purpose_name             : Human-readable name
  - purpose_description      : Detailed description (min 20 chars)
  - legal_basis              : CONSENT or EXPLICIT_CONSENT
  - data_categories          : Categories of data processed
  - retention_period         : Data retention period
  - is_active                : Whether purpose is active
  - requires_explicit        : Whether explicit consent required
  - is_mandatory             : Whether consent mandatory for service
  - created_at               : Creation timestamp
  - created_by               : User who created
  - updated_at               : Last update timestamp
  - updated_by               : User who updated

consent_records:
  - consent_id               : Primary key
  - consent_code             : Unique code (CONS-TIMESTAMP-RANDOM)
  - subject_id               : Subject identifier
  - subject_email            : Subject email
  - subject_name             : Subject name
  - purpose_id               : Foreign key to consent_purposes
  - consent_given            : Whether consent given (0/1)
  - consent_date             : Date consent given
  - consent_method           : Method used (CHECKBOX, SIGNATURE, etc.)
  - consent_version          : Version of consent text
  - consent_text             : Actual consent text shown
  - ip_address               : IP address when consent given
  - user_agent               : Browser user agent
  - withdrawn                : Whether consent withdrawn (0/1)
  - withdrawn_date           : Date withdrawn
  - withdrawn_by             : Who recorded withdrawal
  - withdrawn_reason         : Reason for withdrawal
  - expires_at               : Expiration date (if applicable)
  - is_active                : Whether consent is active
  - consent_hash             : SHA-256 hash for integrity
  - previous_hash            : Hash-chain link
  - created_at               : Creation timestamp

consent_history:
  - history_id               : Primary key
  - consent_id               : Foreign key to consent_records
  - action                   : Action performed
  - action_details           : Details
  - previous_state           : Previous consent_given state
  - new_state                : New consent_given state
  - performed_by             : User who performed action
  - performed_at             : Timestamp
  - history_hash             : SHA-256 hash for integrity
  - previous_history_hash    : Hash-chain link

consent_withdrawal_requests:
  - request_id               : Primary key
  - request_number           : Unique number (WDRL-TIMESTAMP-RANDOM)
  - subject_id               : Subject identifier
  - subject_email            : Subject email
  - withdrawal_scope         : ALL, SPECIFIC, CATEGORY
  - purpose_ids              : Specific purpose IDs (for SPECIFIC scope)
  - withdrawal_reason        : Reason for withdrawal
  - status                   : RECEIVED, COMPLETED
  - received_date            : Date request received
  - completed_date           : Date processed
  - requested_by             : User who created request
  - processed_by             : User who processed
  - request_hash             : SHA-256 hash for integrity
  - previous_hash            : Hash-chain link
  - created_at               : Creation timestamp

consent_preferences:
  - preference_id            : Primary key
  - subject_id               : Subject identifier
  - subject_email            : Subject email
  - preference_type          : Type of preference
  - preference_value         : Preference value
  - updated_at               : Last update timestamp
  - updated_by               : User who updated

-------------------------------------------------------------------------------
CONSENT METHODS
-------------------------------------------------------------------------------

  CHECKBOX       : Online checkbox/tick box
  SIGNATURE      : Physical or electronic signature
  VERBAL         : Verbal consent (recorded)
  WRITTEN        : Written consent form
  DOUBLE_OPT_IN  : Double opt-in (email confirmation)
  API            : API/programmatic consent

-------------------------------------------------------------------------------
WITHDRAWAL SCOPES
-------------------------------------------------------------------------------

  ALL            : Withdraw all consents for subject
  SPECIFIC       : Withdraw specific purpose(s) only
  CATEGORY       : Withdraw by data category

-------------------------------------------------------------------------------
KEY COMPLIANCE FEATURES
-------------------------------------------------------------------------------

1. Demonstrable Consent (Article 7(1))
   - Full audit trail of consent given
   - Method, date, version, and text recorded
   - Hash-chain integrity verification
   - IP address and user agent captured

2. Freely Given (Article 7(4))
   - Separate consent for separate purposes
   - Optional vs mandatory purposes tracked
   - Clear purpose descriptions required

3. Right to Withdraw (Article 7(3))
   - Withdrawal as easy as giving consent
   - Individual or bulk withdrawal
   - Formal withdrawal request workflow
   - Immediate effect on consent status

4. Granular Consent
   - Multiple purposes supported
   - Purpose-specific consent records
   - Category-based withdrawal option

5. Consent Refresh
   - Re-consent functionality
   - Version tracking
   - Updated consent text support

-------------------------------------------------------------------------------
TEST RESULTS
-------------------------------------------------------------------------------

Test File: tests/testthat/test-consent.R
Status: ALL TESTS PASSING
Total Tests: 45 test cases, 116 expectations

Test Categories:
  - Initialization tests (5 expectations)
  - Reference data tests (12 expectations)
  - Purpose management tests (16 expectations)
  - Consent recording tests (20 expectations)
  - Consent withdrawal tests (14 expectations)
  - Withdrawal request tests (16 expectations)
  - Consent checking tests (12 expectations)
  - Consent refresh tests (6 expectations)
  - Statistics tests (4 expectations)
  - Report generation tests (6 expectations)
  - Integration tests (25 expectations)

-------------------------------------------------------------------------------
USAGE EXAMPLES
-------------------------------------------------------------------------------

# Initialize consent system
init_consent()

# Create consent purposes
marketing_purpose <- create_consent_purpose(
  purpose_code = "MARKETING",
  purpose_name = "Marketing Communications",
  purpose_description = "We will use your data to send you marketing communications about our products and services.",
  legal_basis = "CONSENT",
  created_by = "admin",
  data_categories = "Contact, Preferences",
  retention_period = "3 years"
)

research_purpose <- create_consent_purpose(
  purpose_code = "RESEARCH",
  purpose_name = "Research Participation",
  purpose_description = "Your data may be used for approved research studies to advance medical knowledge.",
  legal_basis = "EXPLICIT_CONSENT",
  created_by = "admin",
  requires_explicit = TRUE
)

# Record consent
consent <- record_consent(
  subject_id = "SUBJ-001",
  subject_email = "john@example.com",
  purpose_id = marketing_purpose$purpose_id,
  consent_method = "CHECKBOX",
  recorded_by = "system",
  consent_version = "1.0",
  consent_text = "I agree to receive marketing communications...",
  ip_address = "192.168.1.100"
)

# Check if consent given
check <- check_consent(
  subject_id = "SUBJ-001",
  purpose_id = marketing_purpose$purpose_id
)
if (check$has_consent) {
  # Proceed with processing
}

# Get all consents for subject
consents <- get_subject_consents(subject_id = "SUBJ-001")

# Withdraw specific consent
withdraw_consent(
  consent_id = consent$consent_id,
  withdrawn_by = "subject",
  withdrawn_reason = "No longer interested"
)

# Withdraw all consents for subject
withdraw_all_consents(
  subject_id = "SUBJ-001",
  withdrawn_by = "subject",
  withdrawn_reason = "Account deletion requested"
)

# Create formal withdrawal request
request <- create_withdrawal_request(
  subject_id = "SUBJ-001",
  subject_email = "john@example.com",
  withdrawal_scope = "ALL",
  requested_by = "dpo",
  withdrawal_reason = "Subject exercising right to withdraw"
)

# Process withdrawal request
process_withdrawal_request(
  request_id = request$request_id,
  processed_by = "admin"
)

# Refresh consent (re-consent)
refresh_consent(
  consent_id = consent$consent_id,
  consent_method = "DOUBLE_OPT_IN",
  refreshed_by = "system",
  new_version = "2.0",
  new_consent_text = "Updated consent text..."
)

# Get consent history
history <- get_consent_history(consent$consent_id)

# Get pending withdrawal requests
pending <- get_pending_withdrawal_requests()

# Get statistics
stats <- get_consent_statistics()

# Generate compliance report
generate_consent_report(
  output_file = "consent_report.txt",
  format = "txt",
  organization = "Healthcare Organization",
  prepared_by = "Data Protection Officer"
)

-------------------------------------------------------------------------------
COMPLIANCE STATUS
-------------------------------------------------------------------------------

GDPR Article 7(1) - Demonstrable Consent:
  - Controller must demonstrate consent was given
  - Full audit trail with hash-chain integrity
  - Consent method, date, version, and text recorded
  - IP address and user agent captured

GDPR Article 7(2) - Distinguishable Request:
  - Consent request clearly distinguishable from other matters
  - Purpose-specific consent records
  - Clear, detailed purpose descriptions required (min 20 chars)

GDPR Article 7(3) - Right to Withdraw:
  - Withdrawal as easy as giving consent
  - Individual consent withdrawal
  - Bulk withdrawal for all consents
  - Formal withdrawal request workflow
  - Immediate effect on consent status

GDPR Article 7(4) - Freely Given:
  - Performance not conditional on unnecessary consent
  - Separate consent for separate purposes
  - Optional vs mandatory purposes tracked
  - Granular purpose management

Additional Features:
  - Consent expiration support
  - Consent refresh/renewal
  - Version tracking for consent text updates
  - Comprehensive statistics and reporting
  - JSON and TXT report formats

-------------------------------------------------------------------------------
NEXT STEPS
-------------------------------------------------------------------------------

Features #15, #16, and #17 are now complete. Ready to proceed with:
- Feature #18: Data Retention Enforcement
- Feature #19: CRF Completion Guidelines (CCG) Generator
- Feature #20: CRF Version Control & Change Log

===============================================================================
